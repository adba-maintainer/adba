{% extends "base.html" %} {% block content %}
<h1>
    {% if taxonomy.name == "threat_actor" %}Threat Actor{% elif taxonomy.name ==
    "sector" %}Sector{% elif taxonomy.name == "year" %}Year{% else %}{{
    taxonomy.name | capitalize }}{% endif %}: {{ term.name }}
</h1>
<p>
    <a href="/">&larr; Return to Master Archive</a>
</p>

<table class="ledger-table" id="breach-table">
    <thead>
        <tr>
            <th class="sortable" data-sort="date" data-type="date">
                DATE <span class="sort-indicator">▼</span>
            </th>
            <th class="sortable" data-sort="entity" data-type="text">
                ENTITY <span class="sort-indicator"></span>
            </th>
            <th>SECTOR</th>
            <th class="sortable" data-sort="severity" data-type="severity">
                SEVERITY <span class="sort-indicator"></span>
            </th>
        </tr>
    </thead>
    <tbody>
        {% for page in term.pages %}
        <tr>
            <td data-date="{{ page.date }}">
                <span class="font-mono text-small text-muted"
                    >{{ page.date }}</span
                >
            </td>
            <td data-entity="{{ page.title }}">
                <a href="{{ page.permalink }}">
                    <strong>{{ page.title }}</strong>
                </a>
                <br />
                <span class="text-small text-muted">
                    {% if page.extra.impact and
                    page.extra.impact.affected_individuals and
                    page.extra.impact.affected_individuals > 0 %} {{
                    page.extra.impact.affected_individuals | num_format }}
                    affected {% elif page.extra.impact and
                    page.extra.impact.record_count and
                    page.extra.impact.record_count > 0 %} {{
                    page.extra.impact.record_count | num_format }} records {%
                    elif page.extra.impact and page.extra.impact.data_volume_gb
                    and page.extra.impact.data_volume_gb > 0 %} {{
                    page.extra.impact.data_volume_gb }} GB exfiltrated {% elif
                    page.extra.impact and page.extra.impact.financial_cost_total
                    and page.extra.impact.financial_cost_total > 0 %} ${{
                    page.extra.impact.financial_cost_total | num_format }}
                    impact {% elif page.extra.impact and
                    page.extra.impact.ransom_demanded and
                    page.extra.impact.ransom_demanded > 0 %} ${{
                    page.extra.impact.ransom_demanded | num_format }} ransom {%
                    elif page.extra.impact and page.extra.impact.downtime_hours
                    and page.extra.impact.downtime_hours > 0 %} {{
                    page.extra.impact.downtime_hours }} hours downtime {% else
                    %} Impact unknown {% endif %}
                </span>
            </td>
            <td>
                {% if page.taxonomies.sector %} {% for sector in
                page.taxonomies.sector %}
                <span class="tag sector-{{ sector | slugify}}">
                    {{ sector }}
                </span>
                {% endfor %} {% endif %}
            </td>
            <td data-severity="{{ page.extra.severity }}">
                <span
                    class="severity-badge severity-{{ page.extra.severity | lower }}"
                >
                    {{ page.extra.severity | upper }}
                </span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    (function () {
        const table = document.getElementById("breach-table");
        const tbody = table.querySelector("tbody");
        const headers = table.querySelectorAll("th.sortable");

        let currentSort = { column: "date", direction: "desc" };

        const severityOrder = { Severe: 3, Serious: 2, Minor: 1 };

        function sortTable(column, type) {
            const rows = Array.from(tbody.querySelectorAll("tr"));

            // Toggle direction if clicking same column
            if (currentSort.column === column) {
                currentSort.direction =
                    currentSort.direction === "asc" ? "desc" : "asc";
            } else {
                currentSort.direction = "desc";
            }
            currentSort.column = column;

            rows.sort((a, b) => {
                let aVal, bVal;

                if (type === "date") {
                    aVal = a
                        .querySelector(`td[data-date]`)
                        .getAttribute("data-date");
                    bVal = b
                        .querySelector(`td[data-date]`)
                        .getAttribute("data-date");
                } else if (type === "text") {
                    aVal = a
                        .querySelector(`td[data-entity]`)
                        .getAttribute("data-entity")
                        .toLowerCase();
                    bVal = b
                        .querySelector(`td[data-entity]`)
                        .getAttribute("data-entity")
                        .toLowerCase();
                } else if (type === "severity") {
                    const aSev = a
                        .querySelector(`td[data-severity]`)
                        .getAttribute("data-severity");
                    const bSev = b
                        .querySelector(`td[data-severity]`)
                        .getAttribute("data-severity");
                    aVal = severityOrder[aSev] || 0;
                    bVal = severityOrder[bSev] || 0;
                }

                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;

                return currentSort.direction === "asc"
                    ? comparison
                    : -comparison;
            });

            // Re-append rows in sorted order
            rows.forEach((row) => tbody.appendChild(row));

            // Update sort indicators
            headers.forEach((header) => {
                const indicator = header.querySelector(".sort-indicator");
                if (header.getAttribute("data-sort") === column) {
                    indicator.textContent =
                        currentSort.direction === "asc" ? "▲" : "▼";
                } else {
                    indicator.textContent = "";
                }
            });
        }

        headers.forEach((header) => {
            header.addEventListener("click", () => {
                const column = header.getAttribute("data-sort");
                const type = header.getAttribute("data-type");
                sortTable(column, type);
            });

            // Add pointer cursor
            header.style.cursor = "pointer";
        });
    })();
</script>

{% endblock %}
