{% extends "base.html" %} {% block content %}
<h1>The Archive</h1>

<div class="search-container">
    <input
        type="search"
        id="search-input"
        class="search-input"
        placeholder="Search by organization name or keywords..."
        autocomplete="off"
    />
    <div id="search-results" class="search-results"></div>
</div>

<table class="ledger-table" id="breach-table">
    <thead>
        <tr>
            <th class="sortable" data-sort="date" data-type="date">
                DATE <span class="sort-indicator">▼</span>
            </th>
            <th class="sortable" data-sort="entity" data-type="text">
                ENTITY <span class="sort-indicator"></span>
            </th>
            <th>SECTOR</th>
            <th class="sortable" data-sort="severity" data-type="severity">
                SEVERITY <span class="sort-indicator"></span>
            </th>
        </tr>
    </thead>
    <tbody>
        {% set section = get_section(path="breaches/_index.md") %} {% for page
        in section.pages %}
        <tr>
            <td data-date="{{ page.date }}">
                <span class="font-mono text-small text-muted"
                    >{{ page.date }}</span
                >
            </td>
            <td data-entity="{{ page.title }}">
                <a href="{{ page.permalink }}">
                    <strong>{{ page.title }}</strong>
                </a>
                <br />
                <span class="text-small text-muted">
                    {% if page.extra.impact and
                    page.extra.impact.affected_individuals and
                    page.extra.impact.affected_individuals > 0 %} {{
                    page.extra.impact.affected_individuals | num_format }}
                    affected {% elif page.extra.impact and
                    page.extra.impact.record_count and
                    page.extra.impact.record_count > 0 %} {{
                    page.extra.impact.record_count | num_format }} records {%
                    elif page.extra.impact and page.extra.impact.data_volume_gb
                    and page.extra.impact.data_volume_gb > 0 %} {{
                    page.extra.impact.data_volume_gb }} GB exfiltrated {% elif
                    page.extra.impact and page.extra.impact.financial_cost_total
                    and page.extra.impact.financial_cost_total > 0 %} ${{
                    page.extra.impact.financial_cost_total | num_format }}
                    impact {% elif page.extra.impact and
                    page.extra.impact.ransom_demanded and
                    page.extra.impact.ransom_demanded > 0 %} ${{
                    page.extra.impact.ransom_demanded | num_format }} ransom {%
                    elif page.extra.impact and page.extra.impact.downtime_hours
                    and page.extra.impact.downtime_hours > 0 %} {{
                    page.extra.impact.downtime_hours }} hours downtime {% else
                    %} Impact unknown {% endif %}
                </span>
            </td>
            <td>
                {% if page.taxonomies.sector %} {% for sector in
                page.taxonomies.sector %}
                <span class="tag sector-{{ sector | slugify}}">
                    {{ sector }}
                </span>
                {% endfor %} {% endif %}
            </td>
            <td data-severity="{{ page.extra.severity }}">
                <span
                    class="severity-badge severity-{{ page.extra.severity | lower }}"
                >
                    {{ page.extra.severity | upper }}
                </span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="pagination-controls" class="pagination-controls">
    <button id="prev-btn" class="pagination-btn" disabled>← Previous</button>
    <span id="page-info" class="page-info"></span>
    <button id="next-btn" class="pagination-btn">Next →</button>
</div>

<script>
    (function () {
        const table = document.getElementById("breach-table");
        const tbody = table.querySelector("tbody");
        const headers = table.querySelectorAll("th.sortable");

        let currentSort = { column: "date", direction: "desc" };

        const severityOrder = { Severe: 3, Serious: 2, Minor: 1 };

        function sortTable(column, type) {
            const rows = Array.from(tbody.querySelectorAll("tr"));

            // Toggle direction if clicking same column
            if (currentSort.column === column) {
                currentSort.direction =
                    currentSort.direction === "asc" ? "desc" : "asc";
            } else {
                currentSort.direction = "desc";
            }
            currentSort.column = column;

            rows.sort((a, b) => {
                let aVal, bVal;

                if (type === "date") {
                    aVal = a
                        .querySelector(`td[data-date]`)
                        .getAttribute("data-date");
                    bVal = b
                        .querySelector(`td[data-date]`)
                        .getAttribute("data-date");
                } else if (type === "text") {
                    aVal = a
                        .querySelector(`td[data-entity]`)
                        .getAttribute("data-entity")
                        .toLowerCase();
                    bVal = b
                        .querySelector(`td[data-entity]`)
                        .getAttribute("data-entity")
                        .toLowerCase();
                } else if (type === "severity") {
                    const aSev = a
                        .querySelector(`td[data-severity]`)
                        .getAttribute("data-severity");
                    const bSev = b
                        .querySelector(`td[data-severity]`)
                        .getAttribute("data-severity");
                    aVal = severityOrder[aSev] || 0;
                    bVal = severityOrder[bSev] || 0;
                }

                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;

                return currentSort.direction === "asc"
                    ? comparison
                    : -comparison;
            });

            // Re-append rows in sorted order
            rows.forEach((row) => tbody.appendChild(row));

            // Update sort indicators
            headers.forEach((header) => {
                const indicator = header.querySelector(".sort-indicator");
                if (header.getAttribute("data-sort") === column) {
                    indicator.textContent =
                        currentSort.direction === "asc" ? "▲" : "▼";
                } else {
                    indicator.textContent = "";
                }
            });
        }

        headers.forEach((header) => {
            header.addEventListener("click", () => {
                const column = header.getAttribute("data-sort");
                const type = header.getAttribute("data-type");
                sortTable(column, type);
            });

            // Add pointer cursor
            header.style.cursor = "pointer";
        });

        // Pagination
        const ROWS_PER_PAGE = 20;
        let currentPage = 1;
        let totalRows = 0;
        let allRows = [];

        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const pageInfo = document.getElementById("page-info");
        const paginationControls = document.getElementById(
            "pagination-controls",
        );

        function initPagination() {
            allRows = Array.from(tbody.querySelectorAll("tr"));
            totalRows = allRows.length;
            showPage(1, false); // Don't scroll on initial load
        }

        function showPage(page, shouldScroll = true) {
            currentPage = page;
            const start = (page - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);

            // Hide all rows
            allRows.forEach((row) => (row.style.display = "none"));

            // Show current page rows
            allRows
                .slice(start, end)
                .forEach((row) => (row.style.display = ""));

            // Update pagination controls
            prevBtn.disabled = page === 1;
            nextBtn.disabled = page === totalPages;
            pageInfo.textContent = `Page ${page} of ${totalPages} (${totalRows} incidents)`;

            // Show/hide pagination controls
            if (totalPages <= 1) {
                paginationControls.style.display = "none";
            } else {
                paginationControls.style.display = "flex";
            }

            // Scroll to top of table only when navigating between pages
            if (shouldScroll) {
                table.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        }

        prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        });

        nextBtn.addEventListener("click", () => {
            const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        });

        // Override sortTable to reset to page 1 after sorting
        const originalSortTable = sortTable;
        sortTable = function (column, type) {
            originalSortTable(column, type);
            allRows = Array.from(tbody.querySelectorAll("tr"));
            showPage(1);
        };

        // Initialize pagination
        initPagination();
    })();
</script>

<script src="/elasticlunr.min.js"></script>
<script>
    (function () {
        const searchInput = document.getElementById("search-input");
        const searchResults = document.getElementById("search-results");
        const breachTable = document.getElementById("breach-table");
        let searchIndex = null;

        // Load search index
        fetch("/search_index.en.json")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Search index not found. Run: zola build");
                }
                return response.json();
            })
            .then((data) => {
                searchIndex = elasticlunr.Index.load(data);
                console.log("Search index loaded successfully");
            })
            .catch((err) => {
                console.error("Failed to load search index:", err);
                searchResults.innerHTML =
                    '<div class="search-result-item search-no-results">Search unavailable. Please rebuild the site.</div>';
            });

        function performSearch(query) {
            if (!query || query.length < 2) {
                searchResults.innerHTML = "";
                searchResults.style.display = "none";
                breachTable.style.display = "table";
                return;
            }

            if (!searchIndex) {
                searchResults.innerHTML =
                    '<div class="search-result-item">Loading search index...</div>';
                searchResults.style.display = "block";
                return;
            }

            const results = searchIndex.search(query, {
                fields: {
                    title: { boost: 3 },
                    body: { boost: 1 },
                },
                expand: true,
            });

            if (results.length === 0) {
                searchResults.innerHTML =
                    '<div class="search-result-item search-no-results">No results found for "' +
                    query +
                    '"</div>';
                searchResults.style.display = "block";
                breachTable.style.display = "none";
                return;
            }

            // Display results
            let html =
                '<div class="search-results-header">' +
                results.length +
                " result" +
                (results.length !== 1 ? "s" : "") +
                " found</div>";

            results.slice(0, 10).forEach((result) => {
                const doc = searchIndex.documentStore.getDoc(result.ref);
                // Use the ref (document ID) as the URL, which is already the full URL
                const url = result.ref;
                html += '<a href="' + url + '" class="search-result-item">';
                html +=
                    '<div class="search-result-title">' + doc.title + "</div>";
                if (doc.description) {
                    html +=
                        '<div class="search-result-description">' +
                        doc.description +
                        "</div>";
                }
                html += "</a>";
            });

            searchResults.innerHTML = html;
            searchResults.style.display = "block";
            breachTable.style.display = "none";
        }

        // Debounce search
        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(e.target.value.trim());
            }, 300);
        });

        // Clear search on escape
        searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                searchInput.value = "";
                searchResults.innerHTML = "";
                searchResults.style.display = "none";
                breachTable.style.display = "table";
            }
        });

        // Hide results when clicking outside
        document.addEventListener("click", (e) => {
            if (
                !searchInput.contains(e.target) &&
                !searchResults.contains(e.target)
            ) {
                if (searchInput.value === "") {
                    searchResults.style.display = "none";
                    breachTable.style.display = "table";
                }
            }
        });
    })();
</script>

{% endblock %}
